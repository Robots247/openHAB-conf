// ===================================================================================
// MASTER HEATING CONTROLLER (Hybrid: BMS Heat + Smart DHW)
// ===================================================================================

rule "Master Heating Logic"
when
    Item ZV changed or 
    Item MRZV_Pin changed or
    Item RHZV changed or
    Item gTileFloors changed or
    Item gWoodFloors changed or
    Item DHW_Active changed or 
    Item System_Supply_Temp changed or
    Item Heating_Boost_Active changed or 
    Item Boiler_Control_Mode changed or
    Time cron "0/15 * * * * ?"
then
    var String mode = if(Boiler_Control_Mode.state != NULL) Boiler_Control_Mode.state.toString else "SW_FALLBACK"

    // ---------------------------------------------------------
    // 1. PUMP & RELAY LOGIC
    // ---------------------------------------------------------
    if (ZV.state == ON || MRZV_Pin.state == ON) {
        if (CFH1.state != ON) CFH1.sendCommand(ON)
        // Turn on System Pump
        if (Magna1_Pump.state != ON) Magna1_Pump.sendCommand(ON)
    } else {
        if (CFH1.state != OFF) CFH1.sendCommand(OFF)
        // Turn off System Pump
        if (Magna1_Pump.state != OFF) Magna1_Pump.sendCommand(OFF)
    }

    if (RHZV.state == ON) {
        if (RHP.state != ON) RHP.sendCommand(ON)
        if (CFH2.state != ON) CFH2.sendCommand(ON)
    } else {
        if (RHP.state != OFF) RHP.sendCommand(OFF)
        if (CFH2.state != OFF) CFH2.sendCommand(OFF)
    }

    // ---------------------------------------------------------
    // 2. CALCULATE HEATING LOAD
    // ---------------------------------------------------------
    // [Standard Weights]
    val int w_LR   = if(Weight_LR.state instanceof Number) (Weight_LR.state as Number).intValue else 20
    val int w_GBr  = if(Weight_GBr.state instanceof Number) (Weight_GBr.state as Number).intValue else 15
    val int w_Bmt  = if(Weight_Bmt.state instanceof Number) (Weight_Bmt.state as Number).intValue else 15
    val int w_Gar  = if(Weight_Gar.state instanceof Number) (Weight_Gar.state as Number).intValue else 25
    val int w_Mud  = if(Weight_Mud.state instanceof Number) (Weight_Mud.state as Number).intValue else 5
    val int w_Kit  = if(Weight_Kit.state instanceof Number) (Weight_Kit.state as Number).intValue else 8
    val int w_Den  = if(Weight_Den.state instanceof Number) (Weight_Den.state as Number).intValue else 5
    val int w_MBa  = if(Weight_MBa.state instanceof Number) (Weight_MBa.state as Number).intValue else 5
    val int w_MBe  = if(Weight_MBe.state instanceof Number) (Weight_MBe.state as Number).intValue else 5

    var int currentLoad = 0
    
    // Check High Temp Zone Valves
    if (LRZV.state == ON)   currentLoad = currentLoad + w_LR
    if (GBrZV.state == ON)  currentLoad = currentLoad + w_GBr
    if (BMTZV.state == ON)  currentLoad = currentLoad + w_Bmt
    if (GAZV.state == ON)   currentLoad = currentLoad + w_Gar
    if (MRZV_Pin.state == ON) currentLoad = currentLoad + w_Mud 

    // Check Radiant Zones
    if (KITRH.state == ON)  currentLoad = currentLoad + w_Kit
    if (DENRH.state == ON)  currentLoad = currentLoad + w_Den
    if (MBaRH.state == ON)  currentLoad = currentLoad + w_MBa
    if (MBeRH.state == ON)  currentLoad = currentLoad + w_MBe

    // Check Boost
    if (Heating_Boost_Active.state == ON) currentLoad = currentLoad + 20 

    var Number targetModulation = currentLoad.doubleValue
    if (targetModulation > 100) targetModulation = 100
    
    // Supply Temp Safety Limit
    val Number supplyTemp = if(System_Supply_Temp.state instanceof Number) (System_Supply_Temp.state as Number).doubleValue else 100.0
    if (supplyTemp > 185) targetModulation = 0 
    else if (supplyTemp > 180) targetModulation = targetModulation * 0.5 

    Boiler_Calculated_Load.postUpdate(targetModulation)

    // ---------------------------------------------------------
    // 3. EXECUTION (The "Traffic Cop")
    // ---------------------------------------------------------
    
    val int currentEnableState = if(Lochinvar_Boiler_Enable_Cmd.state != NULL) (Lochinvar_Boiler_Enable_Cmd.state as Number).intValue else 0
    var int requiredEnableCmd = 0

    // PRIORITY 1: DHW (Config 10 / Mode 4)
    // If DHW is Active (Temp < Setpoint), we take full control.
    if (DHW_Active.state == ON) {
        requiredEnableCmd = 8 // Enable Tank Tstat
        
        // Send the Setpoint you want (Vacation or Normal)
        val Number tankTarget = if(DHW_Tank_Target.state instanceof Number) (DHW_Tank_Target.state as Number).doubleValue else 125.0
        
        if (DHW_Tank_Setpoint.state != tankTarget) {
            DHW_Tank_Setpoint.sendCommand(tankTarget)
        }
        // In Mode 4, Boiler handles modulation itself. We don't send Rate.
    } 
    // PRIORITY 2: HEATING (Config 5 / Mode 2)
    // If DHW is satisfied, we allow Heating.
    else if (targetModulation > 0) {
        requiredEnableCmd = 1 // Enable Room Tstat 1 (Heating Enable)
        
        // UNIVERSAL SCALING FIX: Map 0-100% -> 70-180 (Boiler Units)
        // This tricks the boiler if it thinks "Power" is "Setpoint"
        var Number commandValue = (targetModulation / 100.0) * (180.0 - 70.0) + 70.0
        
        if (Lochinvar_Setpoint_Command.state != commandValue) {
            Lochinvar_Setpoint_Command.sendCommand(commandValue.intValue)
        }
    }

    // Send the Enable Command
    if (requiredEnableCmd > 0) {
        // Bitwise check to avoid "1 vs 3" oscillation
        if (currentEnableState.bitwiseAnd(requiredEnableCmd) == 0) {
            Lochinvar_Boiler_Enable_Cmd.sendCommand(requiredEnableCmd)
        }
    } 
    // Shutdown
    else if (targetModulation == 0 && currentEnableState != 0 && DHW_Active.state != ON) {
        Lochinvar_Boiler_Enable_Cmd.sendCommand(0)
        // Reset command to 0/70 (Min)
        Lochinvar_Setpoint_Command.sendCommand(70) 
    }
end

// DHW Thermostat Rule (Makes the decision to switch modes)
rule "DHW Thermostat Control"
when
    Item DHW_Tank_Temperature changed or
    Item DHW_Tank_Target changed
then
    val Number current = if(DHW_Tank_Temperature.state instanceof Number) (DHW_Tank_Temperature.state as Number).doubleValue else 120.0
    val Number target = if(DHW_Tank_Target.state instanceof Number) (DHW_Tank_Target.state as Number).doubleValue else 125.0
    val Number hyst = 5.0 

    if (DHW_Active.state != ON && current < (target - hyst)) {
        DHW_Active.postUpdate(ON)
    }
    else if (DHW_Active.state != OFF && current >= target) {
        DHW_Active.postUpdate(OFF)
    }
end