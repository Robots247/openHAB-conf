import org.eclipse.smarthome.model.script.ScriptServiceUtil

// ===================================================================================
// COMMERCIAL UNIT HEATER CONTROLLER (Garage)
// Features: Timer-Based Fan Sync, Freeze Guard, Performance Monitor
// Updates: Added Watchdog Enforcer (State Reconciliation)
// ===================================================================================

// --- TIMERS & STATE ---
var Timer timerFanDelay = null
var Timer timerPerformance = null
var Timer timerFreezeRecovery = null
var Timer timerManualOverride = null
var Timer timerDutyCycle = null // Failsafe cycling

// --- CONFIGURATION ---
// Fan Delays (in Minutes)
val int FAN_ON_DELAY_MIN = 2 
val int FAN_OFF_DELAY_MIN = 2

// ===================================================================================
// RULE 1: INITIALIZATION
// ===================================================================================
rule "Garage Heater Init"
when
    System started
then
    createTimer(now.plusSeconds(10), [|
        if (GAtest1.state == NULL) GAtest1.sendCommand(OFF)
        // Ensure Boiler Call is synced
        if (GAZV.state == ON && CFH3.state != ON) CFH3.sendCommand(ON)
        logInfo("Garage.Init", "Garage Heater Control Initialized.")
    ])
end

// ===================================================================================
// RULE 2: FAN CONTROL (TIMER BASED "DELAYED SYNC")
// ===================================================================================
rule "Garage Fan Logic (Timer Sync)"
when
    Item GAZV changed
then
    if (System_Maintenance_Mode.state == ON) return;

    // Clear any existing fan timer to prevent overlap
    if (timerFanDelay !== null) {
        timerFanDelay.cancel()
        timerFanDelay = null
    }

    // 1. CALL START (Valve Opens) -> WAIT FOR HEAT
    if (GAZV.state == ON) {
        
        // Trigger Boiler Call
        if (CFH3.state != ON) {
            CFH3.sendCommand(ON)
            logInfo("Garage.Boiler", "Unit Heater Call: Triggering CFH3 (Boiler).")
        }

        // If Fan is already ON, leave it. If OFF, start the delay.
        if (GAtest1.state != ON) {
            logInfo("Garage.Fan", "Heat Call Start. Waiting " + FAN_ON_DELAY_MIN + "m for coil to heat.")
            timerFanDelay = createTimer(now.plusMinutes(FAN_ON_DELAY_MIN), [|
                if (GAZV.state == ON) {
                    GAtest1.sendCommand(ON)
                    logInfo("Garage.Fan", "Fan START: Delay Complete (Coil Ready).")
                }
                timerFanDelay = null
            ])
        } else {
            logInfo("Garage.Fan", "Heat Call Start. Fan already ON (Ignoring Delay).")
        }
    }

    // 2. CALL END (Valve Closes) -> SCAVENGE HEAT
    else if (GAZV.state == OFF) {
        
        // Clear Boiler Call
        if (CFH3.state != OFF) {
            CFH3.sendCommand(OFF)
            logInfo("Garage.Boiler", "Unit Heater Satisfied: Clearing CFH3.")
        }

        // If Fan is ON, keep it running to scavenge heat
        if (GAtest1.state == ON) {
            logInfo("Garage.Fan", "Heat Call End. Scavenging for " + FAN_OFF_DELAY_MIN + "m.")
            timerFanDelay = createTimer(now.plusMinutes(FAN_OFF_DELAY_MIN), [|
                if (GAZV.state == OFF) {
                    GAtest1.sendCommand(OFF)
                    logInfo("Garage.Fan", "Fan STOP: Scavenge Complete.")
                }
                timerFanDelay = null
            ])
        } else {
            // Fan was already off (short cycle), ensure it stays off
            GAtest1.sendCommand(OFF)
            logInfo("Garage.Fan", "Heat Call End. Fan already OFF.")
        }
    }
end

// ===================================================================================
// RULE 3: MANUAL FAN OVERRIDE SYNC
// ===================================================================================
rule "Garage Manual Fan Control"
when
    Item GAtest1 changed
then
    if (System_Maintenance_Mode.state == ON) return;

    // If User turns FAN ON, force Valve ON (Heat)
    if (GAtest1.state == ON && GAZV.state != ON) {
        if (timerFanDelay === null) {
            logInfo("Garage.Manual", "Manual Fan ON detected. Forcing Valve ON.")
            GAZV.sendCommand(ON)
        }
    }
    // If User turns FAN OFF, force Valve OFF
    else if (GAtest1.state == OFF && GAZV.state != OFF) {
        if (timerFanDelay === null) {
            logInfo("Garage.Manual", "Manual Fan OFF detected. Forcing Valve OFF.")
            GAZV.sendCommand(OFF)
        }
    }
end

// =================================================================================
// RULE 4: FREEZE PROTECTION & WATCHDOG (PROFESSIONAL GRADE)
// =================================================================================
// UPDATED: Now triggered by Time Cron (Watchdog) in addition to changes.
rule "Garage Freeze Guard & Watchdog"
when
    Item GAMS_Temp changed or
    Item Outdoor_Temperature changed or
    Time cron "0 0/15 * * * ?" // Runs every 15 minutes to reconcile state
then
    if (System_Maintenance_Mode.state == ON) return;

    // THRESHOLDS (Deadband)
    val double FREEZE_ON  = 38.0 
    val double FREEZE_OFF = 42.0 
    val double CRITICAL_F = 32.0 
    
    var double garageTemp = 100.0
    if (GAMS_Temp.state instanceof Number) garageTemp = (GAMS_Temp.state as Number).doubleValue
    
    var boolean sensorDead = (GAMS_Temp.state == NULL || GAMS_Temp.state == UNDEF)
    if (!sensorDead && GAMS_Temp.lastUpdate !== null && GAMS_Temp.lastUpdate.isBefore(now.minusHours(1))) sensorDead = true

    // 1. FREEZE DETECTED
    if (garageTemp < FREEZE_ON || (sensorDead && (Outdoor_Temperature.state as Number).doubleValue < 20.0)) {
        
        // CHECK OVERRIDE
        if (timerManualOverride !== null && garageTemp > CRITICAL_F) {
            return
        }

        // ACTION: FORCE HEAT (Watchdog ensures this happens even if missed first time)
        if (GAZV.state != ON) {
            logWarn("Garage.Watchdog", "FREEZE RISK DETECTED: Temp " + garageTemp + "F. Forcing Heat ON.")
            
            if (vGA_Heating_OFF_Override.state != ON) vGA_Heating_OFF_Override.sendCommand(ON)
            
            if (GA_Heating_TargetTemp.state == NULL || (GA_Heating_TargetTemp.state as Number).doubleValue < 45.0) {
                GA_Heating_TargetTemp.sendCommand(40.0)
            }
            
            // Direct Valve Control
            GAZV.sendCommand(ON)
        }
        
        // WATCHDOG: Ensure Boiler is Firing if Valve is Open
        if (GAZV.state == ON && CFH3.state != ON) {
             logWarn("Garage.Watchdog", "Valve OPEN but Boiler Call (CFH3) OFF. Forcing CFH3 ON.")
             CFH3.sendCommand(ON)
        }
        
        // If Sensor Dead, cycle blindly
        if (sensorDead && timerDutyCycle === null) {
             logWarn("Garage.Safety", "SENSOR FAILURE: Entering 50% Duty Cycle Failsafe.")
             timerDutyCycle = createTimer(now.plusMinutes(15), [|
                 if (GAZV.state == ON) {
                     GAZV.sendCommand(OFF)
                     logInfo("Garage.Failsafe", "Duty Cycle: OFF (15m)")
                 } else {
                     GAZV.sendCommand(ON)
                     logInfo("Garage.Failsafe", "Duty Cycle: ON (15m)")
                 }
                 timerDutyCycle.reschedule(now.plusMinutes(15))
             ])
        }
    }
    // 2. FREEZE RECOVERY (Hysteresis)
    else if (garageTemp > FREEZE_OFF) {
        
        if (timerDutyCycle !== null) {
            timerDutyCycle.cancel()
            timerDutyCycle = null
            logInfo("Garage.Safety", "Sensor Restored/Safe. Cancelling Failsafe Cycle.")
        }
        
        // WATCHDOG: Ensure Boiler Turns OFF if Valve Closes
        if (GAZV.state == OFF && CFH3.state == ON) {
             // Only turn off if Fan is also OFF (to allow scavenge)
             if (GAtest1.state == OFF) {
                 logWarn("Garage.Watchdog", "Valve CLOSED but Boiler Call (CFH3) ON. Forcing CFH3 OFF.")
                 CFH3.sendCommand(OFF)
             }
        }
    }
end

// =================================================================================
// RULE 5: MANUAL OVERRIDE LOGIC
// =================================================================================
rule "Garage Manual Override Handler"
when
    Item GAZV changed to OFF
then
    // If user turns heat OFF while it's freezing, give them 30 mins
    if (GAMS_Temp.state instanceof Number && (GAMS_Temp.state as Number).doubleValue < 40.0) {
        if (timerManualOverride !== null) timerManualOverride.cancel()
        
        logInfo("Garage.Safety", "Manual OFF detected during cold (" + GAMS_Temp.state + "F). Pausing Freeze Guard for 30 min.")
        timerManualOverride = createTimer(now.plusMinutes(30), [|
            timerManualOverride = null
            logInfo("Garage.Safety", "Manual Override Expired. Re-enabling Freeze Guard.")
        ])
    }
end

// =================================================================================
// RULE 6: PERFORMANCE MONITOR
// =================================================================================
rule "Garage Performance Monitor"
when
    Item GAZV changed to ON
then
    if (GAMS_Temp.state instanceof Number) {
        val double startTemp = (GAMS_Temp.state as Number).doubleValue
        logInfo("Garage.Monitor", "Performance Monitor Started. Start Temp: " + startTemp + "F")
        
        if (timerPerformance !== null) timerPerformance.cancel()
        timerPerformance = createTimer(now.plusMinutes(30), [|
            val double endTemp = (GAMS_Temp.state as Number).doubleValue
            // If temp hasn't risen by 1 degree in 30 mins -> ALARM
            if (endTemp <= startTemp + 1.0) {
                logError("Garage.Monitor", "FAILURE DETECTED: Unit Heater running 30m with no temp rise! (Start:" + startTemp + " End:" + endTemp + ")")
            } else {
                logInfo("Garage.Monitor", "Performance Check Passed. Rose " + (endTemp - startTemp) + "F in 30m.")
            }
            timerPerformance = null
        ])
    }
end

rule "Garage Performance Stop"
when Item GAZV changed to OFF then
    if (timerPerformance !== null) {
        timerPerformance.cancel()
        timerPerformance = null
    }
end