val String filename = "thermostat rules"
// var Timer RHP_timer = null // No longer needed, handled by main logic

// ===================================================================================
// OBSOLETE LOGIC - HANDLED BY heating_logic.rules (MODBUS MASTER)
// ===================================================================================

/* // The new 'heating_logic.rules' file now watches the Zone Valve states directly
// and triggers the pumps/boiler. We don't need these intermediate relays anymore.

    //CFH1 High Temp
    rule "Call For High Heat"
    when    
        Item ZV changed from OFF to ON 
    then 
        if (CFH1.state == OFF) {
        CFH1.sendCommand(ON)
        logInfo(filename, "High Temperature Call For Heat, Activating CFH1")     
        }
    end

    rule "CFH OFF"
    when
        Item ZV changed from ON to OFF
    then
        if(CFH1.state == ON) {
        CFH1.sendCommand(OFF)
        logInfo(filename, "CFH Satisfied, Deactivating CFH1")
        }
    end

    //CFH2 Low temp radiant
    rule "Call For Low Radiant Heat"
    when    
        Item RHP changed from OFF to ON
    then 
        if (CFH2.state == OFF) {
        CFH2.sendCommand(ON)
        logInfo(filename, "Radiant Call For Heat, Activating CFH2")  
        }
    end

    rule "Call For Low Radiant Heat OFF"
    when    
        Item RHP changed from ON to OFF
    then 
        if (CFH2.state == ON) {
        CFH2.sendCommand(OFF)
        logInfo(filename, "Radiant Call For Heat Ended, Deactivating CFH2")  
        }
    end

    //Pumping Rules - Now handled by Master Logic
    rule "Radiant Pump OFF"
    when    
        Item RHZV changed from ON to OFF
    then 
        if(RHP.state == ON) {
        RHP.sendCommand(OFF)
        logInfo(filename, "RHP changed from on to off")
        }
    end
    
    rule "Radiant Pump ON"
    when    
        Item RHZV changed from OFF to ON
    then
        logInfo(filename, "Radiant Heat Activated, Starting 1 minute pump delay")
        RHP_timer = (createTimer(now.plusMinutes(1))[
            logInfo(filename, "Delay over, RHP ON")
            RHP.sendCommand(ON) ]
        )
    end
*/

// ===================================================================================
// ACTIVE ZONE LOGIC
// These rules determine if a room needs heat and open the Zone Valve.
// The Master Logic (heating_logic.rules) watches these valves to fire the boiler.
// ===================================================================================

//RADIANT ZONES

rule "DEN Radiant CFH Thermostat"
    when
        Item DEN_Heating_TargetTemp changed or
        Item DENMS_Temp changed 
    then
        var temperature = (DENMS_Temp.state as Number).doubleValue
        var setpoint = (DEN_Heating_TargetTemp.state as Number).doubleValue
        var hysteresisHigh = (RH_HysteresisHigh.state as Number).doubleValue
        var hysteresisLow = (RH_HysteresisLow.state as Number).doubleValue
        
        sendCommand(Den_TstatTemp, temperature) // Update virtual tstat

        if (temperature < (setpoint - hysteresisLow)) {
            if (DENRH.state != ON) {
                sendCommand(DENRH, ON)
                // Kitchen is tied to Den logic for now
                sendCommand(KITRH,ON) 
                logInfo(filename, "Executing 'DEN Heating Started'")
            }
        }   
        else if (temperature > (setpoint + hysteresisHigh)) {
                if (DENRH.state != OFF) {
                    sendCommand(DENRH, OFF) 
                    sendCommand(KITRH,OFF)
                    logInfo(filename, "Executing 'DEN Heating Ended'")
                }   
        }
end         

rule "Master Bath Radiant Thermostat"
    when
        Item MBe_Heating_TargetTemp changed or
        Item MBeMS_Temp changed 
    then
        var temperature = (MBeMS_Temp.state as Number).doubleValue
        var setpoint = (MBe_Heating_TargetTemp.state as Number).doubleValue
        var hysteresisHigh = (RH_HysteresisHigh.state as Number).doubleValue
        var hysteresisLow = (RH_HysteresisLow.state as Number).doubleValue
        
        sendCommand(MBa_Tstat_Temp, temperature)

        if (temperature < (setpoint - hysteresisLow)) {
            if (MBaRH.state != ON) {
                sendCommand(MBaRH, ON)
                logInfo(filename, "Executing 'Master Bath Heating started'")
            }
        }   
        else if (temperature > (setpoint + hysteresisHigh)) {
            if (MBaRH.state != OFF) {
                sendCommand(MBaRH, OFF)
                logInfo(filename, "Executing 'Master Bath Heating Ended'")
            }   
        }
end     

rule "Master Bedroom Radiant Thermostat"
    when
        Item MBe_Heating_TargetTemp changed or
        Item MBeMS_Temp changed 
    then
        var temperature = (MBeMS_Temp.state as Number).doubleValue
        var setpoint = (MBe_Heating_TargetTemp.state as Number).doubleValue
        var hysteresisHigh = (RH_HysteresisHigh.state as Number).doubleValue
        var hysteresisLow = (RH_HysteresisLow.state as Number).doubleValue
        
        sendCommand(MBe_Tstat_Temp, temperature)

        if (temperature < (setpoint - hysteresisLow)) {
            if (MBeRH.state != ON) {
                sendCommand(MBeRH, ON)
                logInfo(filename, "Executing 'Master Bed Heating started'")
            }
        }   
        else if (temperature > (setpoint + hysteresisHigh)) {
            if (MBeRH.state != OFF) {
                sendCommand(MBeRH, OFF)
                logInfo(filename, "Executing 'Master Bed Heating Ended'")
            }   
        }
end     

// HIGH TEMP ZONES

rule "Living Room CFH Thermostat"
    when
        Item LR_Heating_TargetTemp changed or
        Item LRMS_Temp changed 
    then
        var temperature = (LRMS_Temp.state as Number).doubleValue
        var setpoint = (LR_Heating_TargetTemp.state as Number).doubleValue
        var hysteresisHigh = (ZV_HysteresisHigh.state as Number).doubleValue
        var hysteresisLow = (ZV_HysteresisLow.state as Number).doubleValue
        
        sendCommand(LR_Tstat_Temp, temperature)

        if (temperature < (setpoint - hysteresisLow)) {
            if (LRZV.state != ON) {
                sendCommand(LRZV, ON)
                logInfo(filename, "Executing 'Living Room Thermostat ON'")
            }
        }   
        else if (temperature > (setpoint + hysteresisHigh)) {
            if (LRZV.state != OFF) {
                sendCommand(LRZV, OFF) 
                logInfo(filename, "Executing 'Living Room Heating Ended'")
            }   
        }
end         

rule "Guest BedRoom CFH Thermostat"
    when
        Item GBr_Heating_TargetTemp changed or
        Item GBrMS_Temp changed 
    then
        var temperature = (GBrMS_Temp.state as Number).doubleValue
        var setpoint = (GBr_Heating_TargetTemp.state as Number).doubleValue
        var hysteresisHigh = (ZV_HysteresisHigh.state as Number).doubleValue
        var hysteresisLow = (ZV_HysteresisLow.state as Number).doubleValue

        sendCommand(GBr_Tstat_Temp, temperature)

        if (temperature < (setpoint - hysteresisLow)) {
            if (GBrZV.state != ON) {
                sendCommand(GBrZV, ON)
                logInfo(filename, "Executing 'Guest Bedroom Thermostat ON'")
            }
        }   
        else if (temperature > (setpoint + hysteresisHigh)) {
            if (GBrZV.state != OFF) {
                sendCommand(GBrZV, OFF)
                logInfo(filename, "Executing 'Guest Bed Heating Ended'")
            }   
        }
end          

rule "MudRoom CFH Thermostat"
    when
        Item MR_Heating_TargetTemp changed or
        Item MRMS_Temp changed 
    then
        var temperature = (MRMS_Temp.state as Number).doubleValue
        var setpoint = (MR_Heating_TargetTemp.state as Number).doubleValue
        var hysteresisHigh = (ZV_HysteresisHigh.state as Number).doubleValue
        var hysteresisLow = (ZV_HysteresisLow.state as Number).doubleValue

        sendCommand(MR_Tstat_Temp, temperature)

        if (temperature < (setpoint - hysteresisLow)) {
            if (MRZV.state != ON) {
                sendCommand(MRZV, ON)
                logInfo(filename, "Executing 'Mud Room Thermostat ON'")
            }
        }   
        else if (temperature > (setpoint + hysteresisHigh)) {
            if (MRZV.state != OFF) {
                sendCommand(MRZV, OFF)
                logInfo(filename, "Executing 'Mud Room Heating Ended'")
            }   
        }
end     

rule "Basement CFH Thermostat"
    when
        Item BMT_Heating_TargetTemp changed or
        Item BMTBrMS_Temp changed 
    then
        var temperature = (BMTBrMS_Temp.state as Number).doubleValue
        var setpoint = (BMT_Heating_TargetTemp.state as Number).doubleValue
        var hysteresisHigh = (ZV_HysteresisHigh.state as Number).doubleValue
        var hysteresisLow = (ZV_HysteresisLow.state as Number).doubleValue

        sendCommand(BMT_Tstat_Temp, temperature)

        if (temperature < (setpoint - hysteresisLow)) {
            if (BMTZV.state != ON) {
                sendCommand(BMTZV, ON)
                logInfo(filename, "Executing 'Basement Thermostat ON'")
            }
        }   
        else if (temperature > (setpoint + hysteresisHigh)) {
            if (BMTZV.state != OFF) {
                sendCommand(BMTZV, OFF)
                logInfo(filename, "Executing 'Basement Heating Ended'")
            }   
        }   
end         

rule "Garage CFH Thermostat"
    when
        Item GA_Heating_TargetTemp changed or
        Item GAMS_Temp changed or
        Item vGA_Heating_OFF_Override changed from OFF to ON
    then
        var temperature = (GAMS_Temp.state as Number).doubleValue
        var setpoint = (GA_Heating_TargetTemp.state as Number).doubleValue
        var hysteresisHigh = (GA_HysteresisHigh.state as Number).doubleValue
        var hysteresisLow = (GA_HysteresisLow.state as Number).doubleValue
        
        sendCommand(GA_Tstat_Temp, temperature)

        if (vGA_Heating_OFF_Override.state == ON){
            if (temperature < (setpoint - hysteresisLow)) {
                if (GAZV.state != ON) {
                    sendCommand(GAZV, ON)
                    logInfo(filename, "Executing 'Garage Thermostat ON'")
                }
            }   
            else if (temperature > (setpoint + hysteresisHigh)) {
                if (GAZV.state != OFF) {
                    sendCommand(GAZV, OFF)
                    logInfo(filename, "Executing 'Garage Heating Ended'")
                }   
            }   
        }
        else if (vGA_Heating_OFF_Override.state == OFF) {
             if (GAZV.state == ON) {
                 sendCommand(GAZV, OFF)
                 logInfo(filename, "Garage Override OFF - Forced Valve Close")
             }
        }
end

rule "Garage Overide OFF turns Off Garage Zone Valve "
    when
        Item vGA_Heating_OFF_Override changed from ON to OFF
    then
        logInfo(filename, "Garage Overide turned off Garage zone valve")
        if (GAZV.state == ON){
            sendCommand(GAZV, OFF)
        }
end         

// Unit Heater (CFH3) Logic - PRESERVED but simplified
// This uses the Garage Valve to trigger CFH3. 
// Since CFH3 is a physical relay we might still use, we can keep this logical association
// OR we can let the Master Logic handle it (High Temp call).
// Recommendation: Let the Master Logic handle it.
/*
    rule "Call for High Heat Unit Heater ON"
    when
        Item GAZV changed from OFF to ON
    then
        if (CFH3.state !=ON){
            CFH3.sendCommand(ON)
            logInfo("CFH3.rule", "High Temperature Call for heat required by Unit Heaters")
        }       
    end

    rule "Call for High Heat Unit Heater OFF"
    when 
        Item GAZV changed from ON to OFF
    then
        if (CFH3.state !=OFF){
            CFH3.sendCommand(OFF)
            logInfo("CFH3.rule", "High Temperature Call for Heat satisfied, Turning off CFH3")
        }
    end
*/