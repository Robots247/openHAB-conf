import org.openhab.core.model.script.ScriptServiceUtil

// ===================================================================================
// OPTIMIZED OUTDOOR RESET & "WORST-CASE" FEEDBACK LOGIC
// ===================================================================================

// Global Variables
var Number last_outdoor_smooth = 40.0 // Seed default
var Number room_integral_mem = 0.0    // Local memory for integral

// NEW: Initialization Rule (Sets defaults if MapDB is empty)
rule "Initialize Tuning Parameters"
when
    System started
then
    // Initialize Defaults only if NULL (First run or cache clear)
    if (ODR_Slope.state == NULL || ODR_Slope.state == UNDEF) {
        ODR_Slope.postUpdate(-1.1)
        logInfo("Boiler.Init", "ODR_Slope initialized to default: -1.1")
    }
    if (ODR_Intercept.state == NULL || ODR_Intercept.state == UNDEF) {
        ODR_Intercept.postUpdate(180.0)
        logInfo("Boiler.Init", "ODR_Intercept initialized to default: 180.0")
    }
    if (Room_Kp.state == NULL || Room_Kp.state == UNDEF) {
        Room_Kp.postUpdate(4.0)
        logInfo("Boiler.Init", "Room_Kp initialized to default: 4.0")
    }
    if (Room_Ki.state == NULL || Room_Ki.state == UNDEF) {
        Room_Ki.postUpdate(0.5)
        logInfo("Boiler.Init", "Room_Ki initialized to default: 0.5")
    }
    
    // Initialize Boiler PID defaults if missing
    if (Boiler_Kp.state == NULL || Boiler_Kp.state == UNDEF) {
        Boiler_Kp.postUpdate(2.5)
        logInfo("Boiler.Init", "Boiler_Kp initialized to default: 2.5")
    }
    if (Boiler_Ki.state == NULL || Boiler_Ki.state == UNDEF) {
        Boiler_Ki.postUpdate(0.1)
        logInfo("Boiler.Init", "Boiler_Ki initialized to default: 0.1")
    }
    
    logInfo("Boiler.Init", "Tuning parameters checked.")
end

rule "Calculate Outdoor Reset Target"
when
    Time cron "0 * * ? * *" // Runs every 1 Minute
then
    // 0. FETCH TUNING PARAMETERS (Safe Defaults)
    val Number curveSlope = if(ODR_Slope.state instanceof Number) (ODR_Slope.state as Number).doubleValue else -1.1
    val Number curveIntercept = if(ODR_Intercept.state instanceof Number) (ODR_Intercept.state as Number).doubleValue else 180.0
    val Number Kp_room_val = if(Room_Kp.state instanceof Number) (Room_Kp.state as Number).doubleValue else 4.0
    val Number Ki_room_val = if(Room_Ki.state instanceof Number) (Room_Ki.state as Number).doubleValue else 0.5

    // 1. OUTDOOR SENSOR SMOOTHING
    var Number rawOutdoor = 32.0
    if (Outdoor_Temperature.state instanceof Number) {
        rawOutdoor = (Outdoor_Temperature.state as Number).doubleValue
    }
    last_outdoor_smooth = (0.05 * rawOutdoor) + (0.95 * last_outdoor_smooth)
    val Number outdoorInput = last_outdoor_smooth 

    // 2. DETERMINE DEMAND (Null Safe Checks)
    var boolean highTempCall = false
    var boolean lowTempCall = false
    
    // Check High Temp Zones (Null Safe)
    if ((LRZV.state == ON) || (GBrZV.state == ON) || (BMTZV.state == ON) || (GAZV.state == ON) || (MRZV.state == ON)) {
        highTempCall = true
    }
    
    // Check Low Temp Zones (Null Safe)
    if ((KITRH.state == ON) || (DENRH.state == ON) || (MBaRH.state == ON) || (MBeRH.state == ON)) {
        lowTempCall = true
    }

    // 3. CALCULATE ROOM ERROR (Placeholder / Safety)
    var Number maxErrorHT = 0.0
    var Number maxErrorLT = 0.0
    
    if (Boiler_Max_Error.state instanceof Number) {
        maxErrorHT = (Boiler_Max_Error.state as Number).doubleValue
    }

    // 4. CHECK BOILER STATE (New Logic)
    var int bState = if(Boiler_Graph_State.state instanceof Number) (Boiler_Graph_State.state as Number).intValue else 0
    
    var boolean boilerIsBusy = (bState == 2 || bState < 0)

    // 5. CALCULATE FINAL TARGET
    var Number targetTemp = 0.0
    var String demandType = "None"
    
    if (highTempCall) {
        demandType = "High Temp (PID)"
        var Number baseTarget = curveIntercept + (curveSlope * outdoorInput)
        var Number error = maxErrorHT 
        
        // P-Term
        var Number P_room = Kp_room_val * error
        
        // I-Term
        if (boilerIsBusy) {
            logInfo("Boiler.ODR", "Boiler Busy (State " + bState + "). Freezing PID Integral.")
        } 
        else {
            if (error > 0.1) {
                room_integral_mem = room_integral_mem + (Ki_room_val * error)
            } else {
                room_integral_mem = room_integral_mem * 0.92 // Decay
            }
        }
        
        // Anti-Windup Clamps
        if (room_integral_mem > 20) room_integral_mem = 20
        if (room_integral_mem < -5) room_integral_mem = -5 
        
        Boiler_Room_Integral.postUpdate(room_integral_mem)
        targetTemp = baseTarget + P_room + room_integral_mem
        
        // Temp Clamps
        if (targetTemp > 180) targetTemp = 180
        if (targetTemp < 120) targetTemp = 120
        
    } else if (lowTempCall) {
        demandType = "Low Temp"
        var Number baseTarget = 120.0 + (-0.5 * outdoorInput)
        var Number P_room = 2.0 * maxErrorLT
        targetTemp = baseTarget + P_room
        
        if (targetTemp > 120) targetTemp = 120
        if (targetTemp < 85) targetTemp = 85
        
        room_integral_mem = 0.0
        Boiler_Room_Integral.postUpdate(0)
    } else {
        targetTemp = 0.0
        room_integral_mem = 0.0
    }

    Boiler_Demand_Type.postUpdate(demandType)
    Boiler_Target_Temp.postUpdate(targetTemp)
end