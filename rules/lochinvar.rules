// ---------------------------------------------------------
// THE HEARTBEAT (Dynamic Mode Switcher)
// ---------------------------------------------------------
rule "Lochinvar Boiler Heartbeat"
when
    Time cron "0 * * * * ?" 
then
    // We assume BMS_ALL allows both logic paths
    var String mode = if(Boiler_Control_Mode.state != NULL) Boiler_Control_Mode.state.toString else "SW_FALLBACK"
    var int configBit = 0
    var int enableCmd = 0

    if (mode == "BMS_ALL") {
        if (DHW_Active.state == ON) {
            // MODE 4: Direct DHW Control
            // Config 10 = Tank Tstat(2) + Tank Setpoint(8)
            configBit = 10  
            if ((Lochinvar_Boiler_Enable_Cmd.state as Number).intValue.bitwiseAnd(8) != 0) enableCmd = 8
        } else {
            // MODE 2: Heating Control
            // Config 5 = Enable(1) + Rate(4)
            configBit = 5
            if ((Lochinvar_Boiler_Enable_Cmd.state as Number).intValue.bitwiseAnd(1) != 0) enableCmd = 1
        }
    }
    // Fallback modes
    else if (mode == "SW_FALLBACK") {
        configBit = 1
        if (Boiler_Fallback_Demand.state == ON) enableCmd = 1
    }

    // Send Configuration (This switches the boiler mode!)
    Lochinvar_Control_Mode_Config.sendCommand(configBit) 
    
    // Send Enable Command
    if (enableCmd > 0) {
        val int currentStatus = (Lochinvar_Boiler_Enable_Cmd.state as Number).intValue
        if (currentStatus.bitwiseAnd(enableCmd) == 0) {
            Lochinvar_Boiler_Enable_Cmd.sendCommand(enableCmd)
        }
    }
    
    // Feed Rate Watchdog (HEATING ONLY)
    // Uses Universal Scaling (0-100 -> 70-180)
    if (mode == "BMS_ALL" && DHW_Active.state != ON && enableCmd == 1) {
         if (Boiler_Calculated_Load.state instanceof Number) {
            val Number rawLoad = Boiler_Calculated_Load.state as Number
            var Number targetCommand = 70.0 // Minimum (0%)
            
            if (rawLoad > 0) {
                targetCommand = (rawLoad.doubleValue / 100.0) * (180.0 - 70.0) + 70.0
            }

            if (Math.abs((Lochinvar_Setpoint_Command.state as Number).doubleValue - targetCommand.doubleValue) > 2.0) {
                Lochinvar_Setpoint_Command.sendCommand(targetCommand.intValue)
            }
         }
    }
end