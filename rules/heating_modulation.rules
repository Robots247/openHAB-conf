import org.eclipse.smarthome.model.script.actions.Timer

var Timer mrModulationTimer = null

// CONFIGURATION
val int cycleTimeSeconds = 600  // 10 Minute Total Cycle
val Number safetyTemp = 57.0    // If MR is below this, IGNORE modulation (Safety Override)

rule "Mud Room Smart Modulation (Protect the Den)"
when
    Item MRZV changed or
    Item DENMS_Temp changed or
    Item DEN_Heating_TargetTemp changed
then
    // 1. Check if Mud Room actually wants heat
    if (MRZV.state == ON) {
        
        // 2. Get Data points
        val Number denTemp = DENMS_Temp.state as Number
        val Number denTarget = DEN_Heating_TargetTemp.state as Number
        val Number mrTemp = MRMS_Temp.state as Number // Ensure you have a MR sensor, or remove this check
        
        // 3. Calculate the "Danger Level" (How close is the Den to overheating?)
        // Delta: Positive = Den is HOT. Negative = Den is COLD.
        var Number delta = denTemp - denTarget
        
        // 4. Determine Duty Cycle (Power Level)
        var int onTime = 0
        var String mode = ""

        // SAFETY: If Mud Room is freezing, Full Power regardless of Den
        if (mrTemp < safetyTemp) {
            onTime = cycleTimeSeconds
            mode = "SAFETY OVERRIDE (MR Cold)"
        }
        // SCENARIO A: Den is Cold (> 2°F below target) -> Full Blast
        else if (delta < -2.0) {
            onTime = cycleTimeSeconds // 100% ON
            mode = "Full Power (Den Cold)"
        }
        // SCENARIO B: Den is approaching Target (Within 1°F) -> Throttling
        else if (delta >= -2.0 && delta < 0) {
            onTime = (cycleTimeSeconds * 0.6).intValue // 60% Power (6 min ON, 4 min OFF)
            mode = "Throttling (60%)"
        }
        // SCENARIO C: Den is Warm/Satisfied -> trickle heat only
        else if (delta >= 0) {
            onTime = (cycleTimeSeconds * 0.3).intValue // 30% Power (3 min ON, 7 min OFF)
            mode = "Maintenance (30%)"
        }

        // 5. Execute the Cycle
        // If timer is running, cancel it to restart with new calc
        if (mrModulationTimer !== null) {
            mrModulationTimer.cancel()
        }

        // Start the ON cycle
        if (onTime > 0) {
            MRZV_Pin.sendCommand(ON)
            logInfo("Heating", "Mud Room Modulation: " + mode + ". Valve ON for " + onTime + "s.")
            
            // Schedule the OFF cycle (if not 100%)
            if (onTime < cycleTimeSeconds) {
                mrModulationTimer = createTimer(now.plusSeconds(onTime), [|
                    MRZV_Pin.sendCommand(OFF)
                    logInfo("Heating", "Mud Room Modulation: Cycle OFF.")
                ])
            }
        } else {
            // Should not happen in this logic, but safe default
            MRZV_Pin.sendCommand(OFF)
        }

    } else {
        // Thermostat is satisfied, kill everything
        if (mrModulationTimer !== null) {
            mrModulationTimer.cancel()
            mrModulationTimer = null
        }
        if (MRZV_Pin.state != OFF) {
            MRZV_Pin.sendCommand(OFF)
            logInfo("Heating", "Mud Room Demand satisfied. Valve Closed.")
        }
    }
end