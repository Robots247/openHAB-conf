import org.openhab.core.model.script.ScriptServiceUtil

// ===================================================================================
// INTELLIGENT BOILER SHUTOFF & ENERGY MONITORING (SAFETY SUPERVISOR)
// Updates: Added "Standby Immunity" and "Smart Release" to prevent timer loops
// ===================================================================================

// Global State
var long block_end_time = 0
var long last_dhw_event = 0 // Track when DHW ended to suppress false alarms

// 1. INITIALIZE TUNING DEFAULTS (System Start)
rule "Initialize Shutoff Parameters"
when
    System started
then
    if (Boiler_SmartOverrun_Enable.state == NULL) Boiler_SmartOverrun_Enable.postUpdate(OFF) 
    if (Boiler_Overrun_Threshold.state == NULL) Boiler_Overrun_Threshold.postUpdate(6.0)     
    if (Boiler_Block_Time.state == NULL) Boiler_Block_Time.postUpdate(10)                    
    if (Boiler_Rescue_Threshold.state == NULL) Boiler_Rescue_Threshold.postUpdate(15.0)      
    
    // Default Flow Estimates
    if (Flow_GPM_System.state == NULL) Flow_GPM_System.postUpdate(4.0)   
    if (Flow_GPM_Radiant.state == NULL) Flow_GPM_Radiant.postUpdate(2.5) 
    
    logInfo("Boiler.Shutoff", "Shutoff & Energy parameters initialized.")
end

// 2. TRACK DHW STATE (To create immunity window)
rule "Track DHW End Time"
when
    Item Boiler_Status_Code changed
then
    // If we just left DHW Mode (19)
    if (previousState == 19) {
        last_dhw_event = now.millis
        logInfo("Boiler.Shutoff", "DHW Cycle Ended. Starting 5-minute Immunity Window.")
    }
end

// 3. MAIN MONITOR LOOP (Runs every 15s)
rule "Boiler Supervisor Loop"
when
    Time cron "0/15 * * * * ?" 
then
    // GUARD: Maintenance Mode - Disable Safety Supervisor
    if (System_Maintenance_Mode.state == ON) {
        if (Boiler_Block_Active.state == ON) {
            Boiler_Block_Active.postUpdate(OFF) // Clear block if entering maintenance
            Boiler_Block_Status.postUpdate("Maintenance Mode Active")
        }
        return;
    }

    // A. CALCULATE VIRTUAL FLOW & BTU
    // -------------------------------------------------------------------------------
    var double current_gpm = 0.0
    
    var double gpm_sys = if(Flow_GPM_System.state instanceof Number) (Flow_GPM_System.state as Number).doubleValue else 4.0
    var double gpm_rad = if(Flow_GPM_Radiant.state instanceof Number) (Flow_GPM_Radiant.state as Number).doubleValue else 2.5
    
    if (SysPump.state == ON) current_gpm = current_gpm + gpm_sys
    if (RHP.state == ON) current_gpm = current_gpm + gpm_rad
    
    Boiler_Est_Flow.postUpdate(current_gpm)
    
    // Calculate BTU: (GPM * DeltaT * 500)
    var double delta_t = if(Lochinvar_DeltaT.state instanceof Number) (Lochinvar_DeltaT.state as Number).doubleValue else 0.0
    if (delta_t < 0) delta_t = 0
    
    var double btu_hr = current_gpm * delta_t * 500.0
    Boiler_Output_BTU.postUpdate(btu_hr)

    // B. OVERRUN SUPERVISOR
    // -------------------------------------------------------------------------------
    var double supply = if(System_Supply_Temp.state instanceof Number) (System_Supply_Temp.state as Number).doubleValue else 0.0
    var double target = if(Boiler_Target_Temp.state instanceof Number) (Boiler_Target_Temp.state as Number).doubleValue else 0.0
    var double fireRate = if(Boiler_Firing_Rate.state instanceof Number) (Boiler_Firing_Rate.state as Number).doubleValue else 0.0
    
    var double ovr_thresh = if(Boiler_Overrun_Threshold.state instanceof Number) (Boiler_Overrun_Threshold.state as Number).doubleValue else 6.0
    var double res_thresh = if(Boiler_Rescue_Threshold.state instanceof Number) (Boiler_Rescue_Threshold.state as Number).doubleValue else 15.0
    var int block_min = if(Boiler_Block_Time.state instanceof Number) (Boiler_Block_Time.state as Number).intValue else 10

    // --- DECISION LOGIC ---

    // 1. Are we currently in a "Timer Block"?
    var boolean timer_active = (now.millis < block_end_time)

    // 2. Is the Overrun Condition met right now? (Rate low & Temp High & Valid Target)
    var boolean overrun_condition = false
    if (System_Supply_Temp.state instanceof Number && Boiler_Target_Temp.state instanceof Number) {
        // FIX #1: Added (target > 40.0) check. 
        // If target is 0 (Standby), we ignore "Overrun" because the boiler isn't trying to fire anyway.
        overrun_condition = (supply > (target + ovr_thresh)) && (fireRate < 21.0) && (target > 40.0)
    }
    
    // 3. DHW IMMUNITY CHECK
    // If we finished DHW less than 5 minutes ago, IGNORE overrun.
    if ((now.millis - last_dhw_event) < 300000) { // 300,000ms = 5 minutes
        if (overrun_condition) {
             overrun_condition = false 
        }
    }
    
    // 4. Has the temp dropped enough to release a Normal Block?
    var boolean release_condition = (supply <= target)

    // --- STATE MACHINE ---

    if (Boiler_Block_Active.state == ON) {
        // == WE ARE CURRENTLY BLOCKED ==
        
        if (timer_active) {
            // CASE A: SMART BLOCK (Timer Running)
            var double deficit = target - supply
            
            if (deficit > res_thresh) {
                // Rescue! House is crashing.
                block_end_time = 0
                Boiler_Block_Active.postUpdate(OFF)
                Boiler_Block_Status.postUpdate("RESCUE Activated")
                logInfo("Boiler.Shutoff", "RESCUE: Block broken due to demand spike.")
            } else {
                // Keep Waiting
                var long time_left_ms = block_end_time - now.millis
                var int time_left_min = (time_left_ms / 60000).intValue + 1
                Boiler_Block_Status.postUpdate("Smart Block: " + time_left_min + "m left")
                Boiler_Block_Timer_Rem.postUpdate(time_left_min)
            }
        } 
        else {
            // CASE B: NORMAL BLOCK (Or Smart Timer Expired)
            
            // --- NEW: FETCH OUTDOOR TEMP FOR HYSTERESIS ---
            var double outdoorTemp = 32.0
            if (Outdoor_Temperature.state instanceof Number) outdoorTemp = (Outdoor_Temperature.state as Number).doubleValue
            
            // "Efficiency Hold": True if Mild Day (>40F) + Tank still Hot (>120F)
            // Using System_Supply_Temp (Tank) as requested for accuracy.
            var boolean efficiency_hold = (outdoorTemp > 40.0 && supply > 120.0)

            if (Boiler_SmartOverrun_Enable.state == ON) {
                
                // 1. SAFETY CHECK (Overrun still active?)
                if ((supply > (target + ovr_thresh)) && (target > 40.0)) {
                    // Still too hot AND we still have a call for heat. Stay blocked.
                    Boiler_Block_Status.postUpdate("Timer Done: Waiting for Cooling (<" + (target+ovr_thresh).intValue + ")")
                    Boiler_Block_Timer_Rem.postUpdate(0)
                } 
                // 2. EFFICIENCY CHECK (New Smart Hysteresis)
                else if (efficiency_hold && target > 40.0) {
                     // We are safe (Safety Check passed), but we want to cool the tank deeper for efficiency.
                     // Only applies if we have valid demand (target > 40).
                     Boiler_Block_Active.postUpdate(ON) // Maintain Block
                     Boiler_Block_Status.postUpdate("Efficiency Hold: Cooling Tank to 120F (Cur: " + supply.intValue + "F)")
                     Boiler_Block_Timer_Rem.postUpdate(0)
                }
                else {
                    // Safe to release (Cooled down OR Demand ended)
                    Boiler_Block_Active.postUpdate(OFF)
                    Boiler_Block_Status.postUpdate("Monitoring")
                    Boiler_Block_Timer_Rem.postUpdate(0)
                }
            } else {
                // If Smart Mode is OFF -> We are in Standard Hysteresis.
                if (release_condition) {
                    Boiler_Block_Active.postUpdate(OFF)
                    Boiler_Block_Status.postUpdate("Monitoring")
                } else {
                    Boiler_Block_Status.postUpdate("Limit Reached: Cooling to " + target.intValue)
                }
            }
        }
    } 
    else {
        // == WE ARE CURRENTLY RUNNING ==
        
        if (overrun_condition) {
            // TRIGGER SHUTDOWN
            Boiler_Block_Active.postUpdate(ON)
            
            if (Boiler_SmartOverrun_Enable.state == ON) {
                // Smart Mode: Start the Timer
                block_end_time = now.plusMinutes(block_min).millis
                
                Boiler_Block_Status.postUpdate("Overrun Detected: Smart Block Started")
                logInfo("Boiler.Shutoff", "SMART BLOCK: Rate " + fireRate + "% | Supply " + supply + " > " + (target+ovr_thresh))
            } else {
                // Normal Mode: Just Block
                Boiler_Block_Status.postUpdate("Overrun Detected: Limit Cooling")
                logInfo("Boiler.Shutoff", "NORMAL BLOCK: Limit reached. Shutting down.")
            }
        } else {
            // Normal Operation
            Boiler_Block_Status.postUpdate("Monitoring")
            Boiler_Block_Timer_Rem.postUpdate(0)
        }
    }
end