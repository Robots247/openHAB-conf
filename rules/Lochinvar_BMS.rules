import org.openhab.core.model.script.ScriptServiceUtil

// ===================================================================================
// HYBRID LOCHINVAR LOGIC (Actuator & Firing Control)
// ===================================================================================

// PID Controller Variables (Firing Loop Only)
var Number pid_integral = 0.0

// -----------------------------------------------------------------------------------
// RULE 1: HEARTBEAT & WATCHDOG (Runs every minute)
// -----------------------------------------------------------------------------------
rule "Boiler Heartbeat and Mode Enforcement"
when
    Time cron "0 * * ? * *" 
then
    if (Boiler_Test_Repeat.state == ON) return;
    if (System_Maintenance_Mode.state == ON) return;

    if (Boiler_BMS_ENBLE.state == ON) {
        // === BMS MODE ===
        // Only enforce Enable=1 if we are NOT currently blocked by the Shutoff Rule.
        if (Boiler_Block_Active.state != ON) {
            // Safe Modbus Check
            if (Lochinvar_40002_Boiler_Enable_Cmd.state instanceof Number) {
                if ((Lochinvar_40002_Boiler_Enable_Cmd.state as Number).intValue != 1) {
                     Lochinvar_40002_Boiler_Enable_Cmd.sendCommand(1)
                }
            }
        }
        
        // Always enforce Control Mode 5 (BMS Rate)
        Lochinvar_40001_Control_Mode.sendCommand(5)
        
        // Safety: Ensure Physical CFH Relays are OFF
        if (CFH1.state == ON) CFH1.sendCommand(OFF)
        if (CFH2.state == ON) CFH2.sendCommand(OFF)
    } 
    else {
        // === RELAY/LEGACY MODE ===
        Lochinvar_40001_Control_Mode.sendCommand(0)
        
        if (Lochinvar_40002_Boiler_Enable_Cmd.state instanceof Number) {
            if ((Lochinvar_40002_Boiler_Enable_Cmd.state as Number).intValue != 0) {
                Lochinvar_40002_Boiler_Enable_Cmd.sendCommand(0)
            }
        }
        if (Lochinvar_40003_Rate_Command.state instanceof Number) {
            if ((Lochinvar_40003_Rate_Command.state as Number).intValue != 0) {
                Lochinvar_40003_Rate_Command.sendCommand(0)
            }
        }
    }
end

// -----------------------------------------------------------------------------------
// RULE 2: MAIN FIRING LOOP (Runs every 15 seconds)
// -----------------------------------------------------------------------------------
rule "Hybrid Boiler PID Loop"
when
    Time cron "0/15 * * * * ?"
then
    if (Boiler_Test_Repeat.state == ON) return;
    
    // =======================================================================
    // MAINTENANCE MODE INTERCEPT
    // =======================================================================
    if (System_Maintenance_Mode.state == ON) {
        
        // Manual Boiler Control Logic
        if (Boiler_Manual_Enable.state == ON) {
            // 1. Force Control Mode 5 (BMS Rate)
            Lochinvar_40001_Control_Mode.sendCommand(5)

            // 2. Force Enable (1)
            if (Lochinvar_40002_Boiler_Enable_Cmd.state instanceof Number) {
                if ((Lochinvar_40002_Boiler_Enable_Cmd.state as Number).intValue != 1) {
                     Lochinvar_40002_Boiler_Enable_Cmd.sendCommand(1)
                }
            }

            // 3. Send Manual Rate from Slider
            var Number manualRate = 0
            if (Boiler_Manual_Rate.state instanceof Number) {
                manualRate = (Boiler_Manual_Rate.state as Number).intValue
            }
            
            // Only send if different to prevent bus spam
            if (Lochinvar_40003_Rate_Command.state == NULL || 
               (Lochinvar_40003_Rate_Command.state as Number).intValue != manualRate) {
                   Lochinvar_40003_Rate_Command.sendCommand(manualRate)
            }
            
        } else {
            // Manual Enable is OFF - Force Boiler Standby
             if (Lochinvar_40002_Boiler_Enable_Cmd.state instanceof Number) {
                if ((Lochinvar_40002_Boiler_Enable_Cmd.state as Number).intValue != 0) {
                    Lochinvar_40002_Boiler_Enable_Cmd.sendCommand(0)
                }
            }
            if (Lochinvar_40003_Rate_Command.state instanceof Number) {
                if ((Lochinvar_40003_Rate_Command.state as Number).intValue != 0) {
                    Lochinvar_40003_Rate_Command.sendCommand(0)
                }
            }
        }
        
        // Zero out PID variables so they don't wind up while in maintenance
        pid_integral = 0.0
        Boiler_PID_Output.postUpdate(0)
        Boiler_Final_Command.postUpdate(0)
        
        return; // EXIT RULE HERE
    }
    
    // =======================================================================
    // STANDARD AUTOMATION LOGIC
    // =======================================================================
    
    if (Boiler_BMS_ENBLE.state != ON) {
        pid_integral = 0.0 
        return;
    }

    // 1. CHECK SHUTOFF BLOCK
    // -----------------------------------------------------------------------
    if (Boiler_Block_Active.state == ON) {
        // == HARD SHUTDOWN SEQUENCE ==
        pid_integral = 0.0 
        Boiler_PID_Output.postUpdate(0)
        Boiler_Final_Command.postUpdate(0)
        
        // A. Send 0% Rate
        Lochinvar_40003_Rate_Command.sendCommand(0)
        
        // B. Send DISABLE Command (Standby)
        if (Lochinvar_40002_Boiler_Enable_Cmd.state instanceof Number) {
            if ((Lochinvar_40002_Boiler_Enable_Cmd.state as Number).intValue != 0) {
                 logInfo("Boiler.BMS", "BLOCK ACTIVE: Forcing Enable=0 (Standby)")
                 Lochinvar_40002_Boiler_Enable_Cmd.sendCommand(0)
            }
        }
        // Fall through to keep pumps running (Purge Cycle)
    }

    // 2. GATHER DATA
    var double base_Kp = if(Boiler_Kp.state instanceof Number) (Boiler_Kp.state as Number).doubleValue else 2.5
    var double Ki = if(Boiler_Ki.state instanceof Number) (Boiler_Ki.state as Number).doubleValue else 0.1
    val Number supplyTemp  = if(System_Supply_Temp.state instanceof Number) (System_Supply_Temp.state as Number).doubleValue else 140.0
    val Number targetTemp = if(Boiler_Target_Temp.state instanceof Number) (Boiler_Target_Temp.state as Number).doubleValue else 0.0
    val int zoneWeight = if(Boiler_Zone_Limit.state instanceof Number) (Boiler_Zone_Limit.state as Number).intValue else 0

    // 3. PUMP ACTUATION 
    var boolean highTempCall = false
    var boolean lowTempCall = false

    if (LRZV.state == ON || GBrZV.state == ON || BMTZV.state == ON || GAZV.state == ON || MRZV.state == ON) highTempCall = true
    if (KITRH.state == ON || DENRH.state == ON || MBaRH.state == ON || MBeRH.state == ON) lowTempCall = true

    // Log Logic State for Debugging
    // logInfo("Boiler.Debug", "Demand: High=" + highTempCall + " Low=" + lowTempCall + " SysPump=" + SysPump.state)

    if (highTempCall) { 
        if (SysPump.state != ON) SysPump.sendCommand(ON) 
    } else { 
        if (SysPump.state != OFF) SysPump.sendCommand(OFF) 
    }

    if (lowTempCall) { 
        if (RHP.state != ON) RHP.sendCommand(ON) 
    } else { 
        if (RHP.state != OFF) RHP.sendCommand(OFF) 
    }

    // 4. FIRING PID (Only run if NOT Blocked)
    var Number finalRate = 0.0
    
    // We only calculate PID if Block is OFF
    if (Boiler_Block_Active.state != ON) {
        
        // Ensure Enable=1 if we are coming out of a block
        // CRITICAL FIX: Check if state is NULL before casting
        if (Lochinvar_40002_Boiler_Enable_Cmd.state instanceof Number) {
            if ((Lochinvar_40002_Boiler_Enable_Cmd.state as Number).intValue != 1) {
                Lochinvar_40002_Boiler_Enable_Cmd.sendCommand(1)
            }
        } else {
            // If NULL (Startup), just send it to be safe
            Lochinvar_40002_Boiler_Enable_Cmd.sendCommand(1)
        }

        if ((highTempCall || lowTempCall) && targetTemp > 0) {
            
            var Number error = targetTemp - supplyTemp
            
            // === SMART GAIN SCHEDULING (NEW) ===
            var double dynamic_Kp = base_Kp
            
            if (error > 20) {
                dynamic_Kp = base_Kp * 0.2 
            } else if (error > 10) {
                dynamic_Kp = base_Kp * 0.5
            }
            
            var Number P = dynamic_Kp * error
            pid_integral = pid_integral + (Ki * error)
            
            // Anti-Windup / Clamping
            if (pid_integral > 40) {
                pid_integral = 40
                logInfo("Boiler.PID", "Anti-Windup Active: Target=" + targetTemp + " Actual=" + supplyTemp + " Dev=" + error + ". Pausing I-term.")
            }
            if (pid_integral < -10) pid_integral = -10
            
            var Number rawOutput = P + pid_integral
            Boiler_PID_Output.postUpdate(rawOutput)

            // Clamps
            var Number maxAllowed = zoneWeight * 1.5 
            if (maxAllowed > 100) maxAllowed = 100
            if (rawOutput > maxAllowed) rawOutput = maxAllowed

            if (rawOutput < 10) {
                if (rawOutput > 1) { finalRate = 10 } 
                else { finalRate = 0; pid_integral = 0 }
            } else {
                finalRate = rawOutput
            }
            if (finalRate > 100) finalRate = 100
        } 
        else {
            // No Demand
            finalRate = 0.0
            if (Boiler_Block_Active.state == ON) pid_integral = 0.0 
        }
    } 
    else {
        // Blocked - Ensure rate is 0
        finalRate = 0.0
    }

    Boiler_Final_Command.postUpdate(finalRate)

    // 5. MODBUS COMMAND (SAFE VERSION)
    var int payload = finalRate.intValue
    
    // Safety check on Register 40003
    var int currentRate = -1
    if (Lochinvar_40003_Rate_Command.state instanceof Number) {
        currentRate = (Lochinvar_40003_Rate_Command.state as Number).intValue
    }
    
    if (currentRate != payload) {
        
        // Safety Check on Control Mode (40001)
        // If it's NULL (unknown), we force it to 5 just to be safe
        var int currentMode = 0
        if (Lochinvar_40001_Control_Mode.state instanceof Number) {
            currentMode = (Lochinvar_40001_Control_Mode.state as Number).intValue
        }
        
        if (currentMode != 5) {
             Lochinvar_40001_Control_Mode.sendCommand(5)
             Thread::sleep(200) 
        }
        Lochinvar_40003_Rate_Command.sendCommand(payload)
    }
end