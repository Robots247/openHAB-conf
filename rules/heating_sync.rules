rule "Zone Synchronization (Ride-Along)"
when
    // Only trigger when the boiler STARTS a cycle
    Item gHeatingValves changed from OFF to ON
then
    // Wait 5 seconds for the primary calling zone to stabilize
    createTimer(now.plusSeconds(5), [|
        logInfo("Heating", "Checking for Ride-Along candidates...")
        
        // ========================================================
        // HIGH TEMP ZONES (Radiators)
        // ========================================================

        // --- MUD ROOM ---
        if (MRZV.state == OFF) {
            if (MRMS_Temp.state instanceof Number && MR_Heating_TargetTemp.state instanceof Number) {
                val Number current = MRMS_Temp.state as Number
                val Number target = MR_Heating_TargetTemp.state as Number
                val Number diff = target - current
                
                // Logic: If room is colder than target (diff > 0) AND close (diff < 1.5)
                if (diff > 0 && diff < 1.5) {
                    logInfo("Heating", "Ride-Along: Force-starting Mud Room (Diff: " + diff + "Â°F)")
                    MR_Heating_TargetTemp.sendCommand(target + 1.0)
                }
            }
        }

        // --- LIVING ROOM ---
        if (LRZV.state == OFF) {
            if (LR_Tstat_Temp.state instanceof Number && LR_Heating_TargetTemp.state instanceof Number) {
                val Number current = LR_Tstat_Temp.state as Number
                val Number target = LR_Heating_TargetTemp.state as Number
                val Number diff = target - current
                
                if (diff > 0 && diff < 1.5) {
                    logInfo("Heating", "Ride-Along: Force-starting Living Room")
                    LR_Heating_TargetTemp.sendCommand(target + 1.0)
                }
            }
        }

        // ========================================================
        // LOW TEMP ZONES (Radiant)
        // ========================================================

        // --- KITCHEN (Tile - High Mass) ---
        if (KITRH.state == OFF) {
            if (KITMS_Temp.state instanceof Number && KIT_Heating_TargetTemp.state instanceof Number) {
                val Number current = KITMS_Temp.state as Number
                val Number target = KIT_Heating_TargetTemp.state as Number
                val Number diff = target - current
                
                if (diff > 0 && diff < 1.5) {
                    logInfo("Heating", "Ride-Along: Force-starting Kitchen Radiant")
                    KIT_Heating_TargetTemp.sendCommand(target + 1.0)
                }
            }
        }

        // --- DEN (Wood - Low Mass) ---
        if (DENRH.state == OFF) {
            if (DENMS_Temp.state instanceof Number && DEN_Heating_TargetTemp.state instanceof Number) {
                val Number current = DENMS_Temp.state as Number
                val Number target = DEN_Heating_TargetTemp.state as Number
                val Number diff = target - current
                
                // Note: Strict check (>0) ensures we don't overheat wood if it's already at setpoint
                if (diff > 0 && diff < 1.0) {
                    logInfo("Heating", "Ride-Along: Force-starting Den Radiant")
                    DEN_Heating_TargetTemp.sendCommand(target + 1.0)
                }
            }
        }

        // --- MASTER BATH (Tile - High Mass) ---
        if (MBaRH.state == OFF) {
            if (MBa_Tstat_Temp.state instanceof Number && MBa_Heating_TargetTemp.state instanceof Number) {
                val Number current = MBa_Tstat_Temp.state as Number
                val Number target = MBa_Heating_TargetTemp.state as Number
                val Number diff = target - current
                
                if (diff > 0 && diff < 1.5) {
                    logInfo("Heating", "Ride-Along: Force-starting Master Bath")
                    MBa_Heating_TargetTemp.sendCommand(target + 1.0)
                }
            }
        }
        
        // --- MASTER BED (Wood - Low Mass) ---
        if (MBeRH.state == OFF) {
            if (MBe_Tstat_Temp.state instanceof Number && MBe_Heating_TargetTemp.state instanceof Number) {
                val Number current = MBe_Tstat_Temp.state as Number
                val Number target = MBe_Heating_TargetTemp.state as Number
                val Number diff = target - current
                
                if (diff > 0 && diff < 1.0) {
                    logInfo("Heating", "Ride-Along: Force-starting Master Bed")
                    MBe_Heating_TargetTemp.sendCommand(target + 1.0)
                }
            }
        }
    ])
end